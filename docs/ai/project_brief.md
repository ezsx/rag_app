## Обзор проекта

Проект `rag_app` — это сервис вопросов-ответов (QA) на базе подхода Retrieval-Augmented Generation (RAG) с поддержкой ReAct агентов. Он сочетает полнотекстовый и семантический поиск по коллекции документов (ChromaDB, BM25) и генерацию ответа LLM, предоставляя REST API через FastAPI.

### Назначение
- Предоставление API для поиска и ответа на вопросы с использованием внешнего контекста.
- Поддержка гибридного поиска (BM25 + эмбеддинги) и опционального переранжирования.
- Планирование запросов (Query Planner) для повышения точности за счёт декомпозиции запроса.
- **Agentic ReAct-RAG** с детерминированной логикой принятия решений, coverage check и refinement циклами.

### Основные сервисы и компоненты
- `src/main.py`: точка входа FastAPI, CORS, маршруты v1, глобальная обработка ошибок.
- `src/api/v1/`: роутер и конечные точки: `qa`, `search`, `models`, `collections`, `ingest`, `system`, **`agent`**.
- `src/core/settings.py`: конфигурация (модели, Chroma, кеши, гибрид/ммр/ререйк, агенты), горячая смена моделей. **Qwen2.5-7B-Instruct** как основная модель (16GB VRAM).
- `src/core/deps.py`: фабрики зависимостей (`get_llm`, `get_retriever`, `get_qa_service`, `get_query_planner`, `get_reranker`, **`get_agent_service`** и т.д.).
- `src/services/qa_service.py`: сбор контекста, промптинг и генерация ответа/стриминга.
- `src/services/query_planner_service.py`: построение плана поиска, кеширование планов и результатов слияния.
- `src/services/reranker_service.py`: переранжирование кандидатов (BAAI/bge-reranker-v2-m3).
- **`src/services/agent_service.py`**: **Agentic ReAct-RAG** с детерминированной логикой, coverage check и refinement циклами.
- **`src/services/tools/`**: **7 базовых инструментов** (query_plan, search, rerank, fetch_docs, compose_context, verify, router_select).
- `src/adapters/chroma/retriever.py`: доступ к ChromaDB (HTTP/локально), эмбеддинг‑поиск.
- `src/adapters/search/*`: BM25 индекс/ретривер и гибридный ретривер.
- `src/utils/*`: загрузка/кеширование моделей, сбор промпта, ранжирование (RRF, MMR).
- Данные индекса: `bm25-index/`, векторное хранилище: `chroma-data/`.

### Инварианты и ключевые свойства
- LLM и ретриверы создаются лениво через `lru_cache`; при смене настроек кеши сбрасываются.
- API устойчив к падению зависимостей при старте (warmup опционален, ошибки логируются).
- Планировщик и фьюжн используют встроенный TTL‑кеш (план ~10 мин, фьюжн ~5 мин) при включённом кешировании.
- Гибридный поиск и MMR/ререйк опциональны и настраиваются через переменные окружения.
- Основной контекст хранится в ChromaDB коллекции, имя коллекции — часть конфигурации и может переключаться «на лету».
- **Agentic ReAct-RAG** использует детерминированную логику с coverage check (≥80%) и refinement циклами (≤1 раунд).
- **7 базовых инструментов** регистрируются в deps.py с инъекцией зависимостей (retriever, settings и др.).
- **Основная модель Qwen2.5-7B-Instruct** оптимизирована для 16GB VRAM с контекстом 8k токенов.

### Безопасность и платформа (актуально)
- JWT‑аутентификация и авторизация: `src/core/auth.py`; обязательная проверка в `agent` эндпойнтах.
- Rate limiting middleware с экспоненциальным бэкоффом: `src/core/rate_limit.py`; экспонирование заголовков в CORS.
- Валидация и санитизация ввода (`SecurityManager`): `src/core/security.py`; защита от prompt‑injection, ограничение размера/глубины JSON.
- Санитизация при логировании через `sanitize_for_logging`.

### Agentic ReAct-RAG (актуально)
- **Детерминированная логика**: coverage check (≥80%), refinement циклы (≤1 раунд), верификация ответов (confidence ≥0.6).
- **Decoding‑профиль**: temperature=0.2–0.4, top_p=0.9, top_k=40, repeat_penalty=1.15–1.2, seed=42.
- **Lost‑in‑the‑Middle mitigation** и `citation_coverage` в `compose_context`.
- **7 базовых инструментов**: query_plan, search, rerank, fetch_docs, compose_context, verify, router_select.
- **Основная модель**: Qwen2.5-7B-Instruct (16GB VRAM, 8k контекст, русскоязычная поддержка).

### Соответствие research/playbook
- Единые параметры декодирования, ограничение шагов ReAct, таймауты инструментов.
- Кеширование плана/фьюжна в указанные TTL.
- Контроль качества: акцент на покрытие цитат и стабильность форматов.

### Рефакторинг агентских инструментов (текущая сессия)

#### Удаленные инструменты (13 шт.):
**Обоснование удаления**: Эти инструменты признаны избыточными для MVP агентской системы или дублируют базовую функциональность.

- **content_filter** - фильтрация контента (слишком специализированная функция)
- **dedup_diversify** - дедупликация и диверсификация (функциональность частично перекрыта RRF/MMR)
- **export_to_formats** - экспорт в различные форматы (не основной use case агента)
- **extract_entities** - извлечение сущностей (слишком нишевая функция)
- **fact_check_advanced** - продвинутый фактчекинг (заменен на базовый verify инструмент)
- **semantic_similarity** - семантическое сходство (функциональность перекрыта rerank)
- **summarize** - суммаризация (не критична для агентского цикла)
- **temporal_normalize** - нормализация дат (обработка дат встроена в query_plan)
- **translate** - перевод (не основной use case)
- **math_eval** - математические вычисления (специфичный случай)
- **multi_query_rewrite** - перезапись запросов (функциональность встроена в query_plan)
- **time_now** - текущие дата/время (слишком простая функция)
- **web_search** - поиск в веб (расширяет scope за пределы локальной базы знаний)

#### Добавленные базовые инструменты:
- **query_plan** - планирование запросов с фильтрами метаданных
- **search** - гибридный поиск с RRF слиянием и fallback на BM25
- **rerank** - переранжирование результатов через кросс-энкодер модель

#### Обновленные компоненты:
- **AgentService** - улучшена логика детерминированного ReAct, системный промпт, обработка ошибок
- **Настройки и зависимости** - обновлены конфигурации в core модулях

**Результат**: Архитектура агента упрощена и сфокусирована на базовой функциональности планирования-поиска-ранжирования, что улучшает стабильность и уменьшает сложность системы.

### Milestone 1: Стабильный ReAct-RAG агент (текущий статус)

**Достигнутые улучшения**:
- ✅ **Query Planner**: работает стабильно за 9 секунд с таймаутом 15с
- ✅ **Гибридный поиск**: находит 10+ релевантных документов с правильными ID
- ✅ **Compose Context**: формирует контекст с покрытием 1.0 после refinement
- ✅ **Верификация**: работает с confidence scoring (0.938) и возвращает evidence
- ✅ **Логирование**: детальная диагностика всех этапов работы агента
- ✅ **Refinement**: автоматическое улучшение покрытия при недостаточности

**Текущие ограничения**:
- ⚠️ Финальный ответ формируется через обходной путь (не через инструмент FinalAnswer)
- ⚠️ Ответ модели содержит устаревшую информацию (Claude/PaLM вместо актуальных моделей)

**Метрики качества**:
- Время планирования: ~9 секунд
- Количество найденных документов: 10+ в первом поиске, 168+ после refinement
- Покрытие контекста: достигает 1.0 после refinement
- Уверенность верификации: 0.938 (высокая)
- Стабильность: агент завершает цикл без критических ошибок

**Следующие шаги**:
1. Исправить механизм финального ответа (убрать необходимость в инструменте FinalAnswer)
2. Улучшить актуальность ответов модели (добавить больше свежих данных)
3. Оптимизировать таймауты на основе реальных метрик
4. Добавить поддержку стриминга ответов


