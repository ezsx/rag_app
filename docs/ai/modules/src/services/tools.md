# Agent Tools - Инструменты для ReAct агента

## Обзор

Набор инструментов для ReAct агента, предоставляющих различные возможности: поиск, обработку контекста, математические вычисления, проверку фактов и получение времени.

## Архитектура инструментов

### ToolRunner
Центральный компонент для управления инструментами:
- Регистрация инструментов с таймаутами
- Изоляция выполнения в отдельных потоках
- JSON-трейсинг всех вызовов
- Обработка ошибок и таймаутов

### Схемы данных
- `ToolRequest`: запрос к инструменту (tool, input)
- `ToolResponse`: ответ инструмента (ok, data, meta)
- `AgentAction`: действие агента с результатом (step, tool, input, output)

## Доступные инструменты

### 1. router_select
**Назначение**: Выбор оптимального маршрута поиска

**Параметры**:
- `query` (str): Поисковый запрос

**Возвращает**:
```json
{"route": "dense|bm25|hybrid", "reasons": ["rule_based"]}
```

**Логика**:
- Короткие/числовые/даты → bm25
- Разговорные/длинные → dense
- Смешанные признаки → hybrid

### 2. fetch_docs
**Назначение**: Получение документов по списку ID

**Параметры**:
- `ids` (List[str]): Список идентификаторов документов
- `window` (List[int], optional): Окно для контекста

**Возвращает**:
```json
{"docs": [{"id": "...", "text": "...", "metadata": {}}]}
```

### 3. compose_context
**Назначение**: Сборка контекста из документов с цитированием

**Параметры**:
- `docs` (List[Dict]): Список документов
- `max_tokens_ctx` (int): Максимум токенов контекста (по умолчанию 1800)
- `citation_format` (str): Формат цитирования (по умолчанию "footnotes")

**Возвращает**:
```json
{
  "prompt": "[1] Текст документа...\n\n[2] Другой документ...",
  "citations": [{"id": "doc1", "index": 1}],
  "contexts": ["Текст документа...", "Другой документ..."]
}
```

### 4. dedup_diversify
**Назначение**: Дедупликация и диверсификация результатов через MMR

**Параметры**:
- `hits` (List[Dict]): Список результатов поиска
- `lambda_` (float): Параметр MMR для баланса релевантность/разнообразие
- `k` (int): Количество результатов на выходе

**Возвращает**:
```json
{"hits": [...]} // Отфильтрованный и упорядоченный список
```

### 5. verify
**Назначение**: Проверка утверждений через поиск в базе знаний

**Параметры**:
- `query` (str): Исходный запрос пользователя
- `claim` (str): Утверждение для проверки
- `top_k` (int): Количество документов для поиска (по умолчанию 3)

**Возвращает**:
```json
{
  "verified": true,
  "confidence": 0.85,
  "evidence": ["Подтверждающий документ 1", "Документ 2"],
  "threshold": 0.6,
  "documents_found": 2
}
```

### 6. math_eval
**Назначение**: Безопасное вычисление математических выражений

**Параметры**:
- `expression` (str): Математическое выражение

**Возвращает**:
```json
{
  "result": 4,
  "expression": "2 + 2",
  "success": true,
  "type": "int"
}
```

**Поддерживаемые операции**:
- Базовая арифметика: +, -, *, /, //, %, **
- Математические функции: sqrt, sin, cos, tan, log, exp, abs, round, max, min, sum
- Константы: pi, e
- Списки: [1, 2, 3] для функций max/min/sum

**Безопасность**:
- AST-парсинг без eval()
- Whitelist разрешенных операций
- Блокировка import и системных вызовов

### 7. time_now
**Назначение**: Получение текущего времени в различных форматах

**Параметры**:
- `format` (str): Формат времени (по умолчанию "iso")
  - "iso": ISO 8601 формат
  - "timestamp": Unix timestamp
  - "readable": Читаемый формат
  - "date": Только дата (YYYY-MM-DD)
  - "time": Только время (HH:MM:SS)
  - "datetime": Дата и время
  - "rfc3339": RFC 3339 формат
- `timezone_name` (str): Временная зона (по умолчанию "UTC")

**Возвращает**:
```json
{
  "current_time": "2023-12-01T15:30:45.123456+00:00",
  "timezone": "UTC",
  "timestamp": 1701443445.123456,
  "format_used": "iso",
  "year": 2023,
  "month": 12,
  "day": 1,
  "hour": 15,
  "minute": 30,
  "second": 45,
  "weekday": "Friday",
  "month_name": "December"
}
```

## Регистрация инструментов

Инструменты регистрируются в `core.deps.get_agent_service()`:

```python
# Инструменты без зависимостей
tool_runner.register("router_select", router_select)
tool_runner.register("math_eval", math_eval)
tool_runner.register("time_now", time_now)

# Инструменты с зависимостями через обертки
def verify_wrapper(**kwargs):
    return verify(retriever=retriever, **kwargs)

tool_runner.register("verify", verify_wrapper)
```

## Обработка ошибок

- Таймауты: каждый инструмент имеет настраиваемый таймаут
- Изоляция: ошибки в одном инструменте не влияют на другие
- JSON-трейсинг: все вызовы логируются с метаданными
- Fallback: невалидные параметры обрабатываются как raw_input

## Расширение

Для добавления нового инструмента:
1. Создать функцию в `src/services/tools/`
2. Зарегистрировать в `get_agent_service()`
3. Добавить описание в `get_available_tools()`
4. Написать тесты в `src/tests/test_new_tools.py`
