# query_plan - Инструмент планирования запросов

## Обзор

Инструмент `query_plan` создает структурированный план поиска для заданного запроса пользователя. Используется агентом для декомпозиции сложных запросов на более простые подзапросы с учетом фильтров метаданных.

## Функциональность

### Основные возможности
- **Декомпозиция запроса**: Разбиение сложного запроса на нормализованные подзапросы
- **Фильтрация метаданных**: Поддержка фильтров по датам, каналам, авторам, просмотрам
- **Кеширование планов**: Интеграция с сервисом планировщика для кеширования результатов
- **Пост-валидация**: Проверка корректности созданного плана

### Параметры
- `query` (str): Текст запроса пользователя
- `settings` (Settings, опционально): Настройки приложения
- `query_planner` (QueryPlannerService, опционально): Сервис планировщика

### Возвращаемые данные
```python
{
    "plan": {
        "normalized_queries": ["query1", "query2"],
        "must_phrases": ["phrase1"],
        "should_phrases": ["phrase2"],
        "metadata_filters": {...},
        "k_per_query": 10,
        "fusion": "rrf"
    },
    "cache_hit": false
}
```

## Интеграция с агентом

Инструмент используется в ReAct цикле агента для:
1. Создания начального плана поиска перед выполнением запроса
2. Оптимизации стратегии поиска на основе характеристик запроса
3. Применения фильтров метаданных для повышения точности

## Обработка ошибок

- Возврат `None` при отсутствии сервиса планировщика
- Обработка пустых запросов
- Логирование ошибок с детализацией

## Производительность

- Измерение времени выполнения (`took_ms`)
- Логирование ключевых параметров плана для отладки
- Интеграция с системой логирования приложения