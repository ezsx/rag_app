# rerank - Инструмент переранжирования результатов

## Обзор

Инструмент `rerank` переранжировывает документы по релевантности к поисковому запросу с использованием кросс-энкодер модели BAAI/bge-reranker-v2-m3.

## Функциональность

### Основные возможности
- **Кросс-энкодер ранжирование**: Использование специализированной модели для переранжирования
- **Гибкая конфигурация**: Настраиваемое количество результатов (top_n)
- **Интеграция с hits**: Поддержка прямой работы с результатами поиска
- **Стандартизированный вывод**: Возврат индексов и scores в едином формате

### Параметры
- `query` (str): Поисковый запрос для ранжирования
- `docs` (List[str]): Список документов для переранжирования
- `top_n` (int, опционально): Количество лучших результатов
- `reranker` (RerankerService, опционально): Сервис переранжирования
- `hits` (List[Dict], опционально): Альтернативный источник документов

### Возвращаемые данные
```python
{
    "indices": [0, 2, 1],  # индексы документов в порядке убывания релевантности
    "scores": [0.95, 0.87, 0.72],  # соответствующие scores
    "top_n": 3
}
```

## Алгоритм работы

1. **Валидация входных данных**: Проверка наличия запроса и документов
2. **Извлечение документов**: Получение текстов из hits или прямое использование docs
3. **Определение top_n**: Установка количества результатов по умолчанию или заданному значению
4. **Переранжирование**: Вызов RerankerService для выполнения ранжирования
5. **Генерация scores**: Создание оценок релевантности для отсортированных документов

## Интеграция с агентом

Используется в ReAct цикле для:
- Повышения качества результатов поиска после начального поиска
- Оптимизации порядка документов перед составлением контекста
- Улучшения релевантности финального ответа

## Обработка ошибок

- Возврат пустого результата при отсутствии reranker сервиса
- Обработка ошибок переранжирования с логированием
- Graceful degradation при проблемах с моделью

## Производительность

- Фиксированный batch_size=16 для оптимальной производительности
- Логирование времени выполнения операций
- Интеграция с системой мониторинга приложения

## Конфигурация

Инструмент полагается на:
- RerankerService с предзагруженной моделью bge-reranker-v2-m3
- Настройки модели через переменные окружения
- Кеширование модели через lru_cache в сервисе