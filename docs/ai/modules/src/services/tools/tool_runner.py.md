# tool_runner - Инфраструктура выполнения инструментов агента

## Обзор

Модуль `tool_runner` предоставляет инфраструктуру для регистрации и выполнения инструментов агента с поддержкой таймаутов, логирования и трассировки. Обеспечивает единообразный интерфейс выполнения всех инструментов агентской системы.

## Функциональность

### Основные возможности
- **Регистрация инструментов**: Регистр `name -> func` для всех доступных инструментов
- **Таймаут-исполнение**: Выполнение инструментов с ограничением времени в отдельных потоках
- **Детальное логирование**: JSON-трассировка всех вызовов инструментов
- **Обработка ошибок**: Graceful обработка таймаутов и исключений
- **Метаданные**: Сбор метрик производительности и статистики

### Параметры и настройки
- **timeout_sec** (float): Таймаут выполнения инструмента (по умолчанию 5 секунд)
- **max_workers** (int): Количество рабочих потоков для параллельного выполнения
- **logging_format**: Структурированный JSON формат для трассировки

## Архитектура

### Класс ToolRunner

```python
class ToolRunner:
    def __init__(self, timeout_sec: float = 5.0)
    def register_tool(self, name: str, func: Callable, timeout_sec: float = None)
    def run(self, request_id: str, step: int, tool_request: ToolRequest) -> ToolResponse
    def get_available_tools(self) -> Dict[str, Dict[str, Any]]
```

### Внутренние классы

#### _ToolEntry
- `name`: Имя инструмента
- `func`: Функция-исполнитель инструмента
- `timeout_sec`: Индивидуальный таймаут для инструмента

#### TimeoutError
- Кастомное исключение для обработки таймаутов

## Процесс выполнения

1. **Регистрация**: Инструменты регистрируются в ToolRunner при инициализации агента
2. **Вызов**: AgentService вызывает `run()` с ToolRequest
3. **Таймаут-исполнение**: Функция выполняется в отдельном потоке с ограничением времени
4. **Логирование**: Каждый вызов логируется в JSON формате для трассировки
5. **Обработка результатов**: Возврат ToolResponse с результатами или ошибкой

## Логирование и трассировка

### Формат JSON лога:
```json
{
    "req": "request_id",
    "step": 1,
    "tool": "search",
    "ok": true,
    "took_ms": 150,
    "error": null
}
```

### Каналы логирования:
- **stdout**: Структурированный вывод для внешних систем мониторинга
- **logging**: Интеграция с системой логирования приложения
- **Файлы**: Опциональное сохранение трассировки в файлы

## Текущие зарегистрированные инструменты

После рефакторинга в ToolRunner зарегистрированы 7 базовых инструментов:

1. **query_plan** - планирование запросов
2. **search** - гибридный поиск документов
3. **rerank** - переранжирование результатов
4. **fetch_docs** - получение документов по ID
5. **compose_context** - сборка контекста с цитированием
6. **verify** - верификация утверждений
7. **router_select** - выбор маршрута поиска

## Конфигурация таймаутов

| Инструмент | Таймаут (сек) | Обоснование |
|------------|---------------|-------------|
| query_plan | 8-10 | Планирование может требовать нескольких LLM вызовов |
| search | 5-7 | Поиск по индексам с потенциальным fallback |
| rerank | 4-6 | Кросс-энкодер модель требует времени на обработку |
| fetch_docs | 3-5 | Простая загрузка документов |
| compose_context | 2-3 | Локальная обработка контекста |
| verify | 4-6 | Поиск для верификации может быть сложным |
| router_select | 1-2 | Простая эвристика анализа текста |

## Интеграция с агентом

- Создается в `core.deps.get_agent_service()`
- Инструменты регистрируются автоматически при инициализации
- Поддержка горячей замены инструментов через сброс кеша
- Интеграция с системой мониторинга производительности

## Обработка ошибок

- **Таймауты**: Возврат ToolResponse с ошибкой таймаута
- **Исключения**: Логирование стектрейса и возврат ToolResponse с ошибкой
- **Некорректные параметры**: Валидация входных данных перед выполнением
- **Зависимости**: Graceful degradation при недоступности внешних сервисов

## Производительность

- **Потокобезопасность**: ThreadPoolExecutor для параллельного выполнения
- **Ресурсоэффективность**: Ограничение количества одновременных операций
- **Мониторинг**: Метрики took_ms для анализа производительности
- **Кеширование**: Интеграция с кеш-системой приложения


