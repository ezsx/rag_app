# compose_context - Инструмент сборки контекста с цитированием

## Обзор

Инструмент `compose_context` собирает контекст из документов с автоматическим цитированием и оптимизацией расположения для лучшего восприятия LLM. Реализует mitigation "lost in the middle" эффекта через специальную перестановку документов.

## Функциональность

### Основные возможности
- **Автоматическое цитирование**: Нумерованные источники в формате `[1]`, `[2]`, etc.
- **Ограничение контекста**: Контроль размера контекста через max_tokens_ctx параметр
- **Lost-in-the-middle mitigation**: Специальная перестановка документов для лучшего восприятия
- **Расчет покрытия**: Вычисление citation_coverage метрики
- **Гибкий ввод**: Поддержка документов с метаданными и score

### Параметры
- `docs` (List[Dict]): Список документов формата `[{id, text, metadata, score?}]`
- `max_tokens_ctx` (int): Максимальное количество токенов контекста (по умолчанию 1800)
- `citation_format` (str): Формат цитирования (по умолчанию "footnotes")
- `enable_lost_in_middle_mitigation` (bool): Включение оптимизации расположения (по умолчанию True)

### Возвращаемые данные
```python
{
    "prompt": str,              # Готовый контекст для LLM
    "citations": [              # Список цитирований
        {
            "id": "string",     # ID источника
            "index": int,       # Номер цитирования
            "metadata": {...}   # Метаданные источника
        }
    ],
    "contexts": List[str],      # Тексты документов
    "citation_coverage": float  # Метрика покрытия (0.0-1.0)
}
```

## Алгоритм работы

1. **Конвертация токенов**: Преобразование лимита токенов в символы (1 токен ≈ 4 символа)
2. **Сбор документов**: Обработка документов с усечением по лимиту символов
3. **Индексация**: Присвоение порядковых номеров документам
4. **Lost-in-the-middle mitigation**: Перестановка документов для оптимального восприятия:
   - Наиболее релевантные документы размещаются в начале и конце
   - Менее релевантные помещаются в середину
5. **Формирование промпта**: Сборка финального контекста с цитированием
6. **Расчет метрик**: Вычисление citation_coverage

## Интеграция с агентом

Используется в ReAct цикле для:
- Сборки контекста после этапа `search` или `rerank`
- Подготовки данных для финального ответа агента
- Обеспечения traceability через систему цитирования
- Оптимизации качества ответа через расположение документов

## Обработка ошибок

- Обработка пустого списка документов
- Graceful усечение документов по лимиту символов
- Сохранение структуры ответа при частичных ошибках

## Производительность

- Эффективная обработка больших списков документов
- Минимизация памяти через потоковую обработку
- Оптимизация алгоритма lost-in-the-middle для различных размеров контекста

## Качество контекста

Алгоритм обеспечивает:
- **Релевантность**: Приоритет наиболее релевантных документов
- **Цитируемость**: Четкая система ссылок на источники
- **Оптимальность**: Расположение документов для лучшего восприятия LLM
- **Покрытие**: Метрика citation_coverage для оценки качества


