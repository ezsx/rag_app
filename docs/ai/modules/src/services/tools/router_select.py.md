# router_select - Инструмент выбора маршрута поиска

## Обзор

Инструмент `router_select` выполняет эвристический анализ запроса пользователя для выбора оптимального маршрута поиска между BM25, dense и hybrid стратегиями. Использует правила на основе характеристик текста запроса.

## Функциональность

### Основные возможности
- **Анализ длины запроса**: Короткие запросы направляются на BM25, длинные - на dense
- **Распознавание паттернов**: Определение чисел, дат, сущностей, фильтров
- **Детекция разговорного стиля**: Распознавание вопросительных конструкций
- **Объяснение решений**: Возврат списка причин выбора маршрута

### Параметры
- `query` (str): Текст запроса пользователя для анализа

### Возвращаемые данные
```python
{
    "route": "bm25|dense|hybrid",    # Выбранный маршрут поиска
    "reasons": ["reason1", "reason2"] # Список причин выбора
}
```

## Алгоритм работы

### Регулярные выражения для анализа
- **Числа**: `\b\d+[\d\-:\./]*\b` - числа с разделителями
- **Даты**: `\b(\d{4}[\-/]\d{1,2}[\-/]\d{1,2}|\d{1,2}[\./]\d{1,2}[\./]\d{2,4})\b` - форматы дат
- **Сущности**: `[@#][\w_]+|https?://\S+` - упоминания и ссылки

### Правила маршрутизации

1. **BM25 маршрут** (точный поиск):
   - Запросы короче 16 символов
   - Короткие запросы (≤40 символов) с числами/датами/сущностями

2. **Dense маршрут** (семантический поиск):
   - Разговорные запросы с вопросительными словами ("почему", "как", "объясни")
   - Длинные запросы (>120 символов)
   - Запросы без явных признаков терминальности

3. **Hybrid маршрут** (комбинированный поиск):
   - Запросы с явными фильтрами ("channel:", "date:", "after:")
   - Смешанные признаки (числа + разговорные элементы)
   - Сомнительные случаи как безопасный дефолт

## Интеграция с агентом

Используется в ReAct цикле для:
- Выбора оптимальной стратегии поиска перед выполнением запроса
- Адаптации поиска под тип запроса пользователя
- Обеспечения баланса между точностью и семантикой

## Качество решений

Алгоритм обеспечивает:
- **Детерминированность**: Повторные вызовы дают одинаковый результат
- **Объяснимость**: Список причин помогает в отладке
- **Безопасность**: Hybrid как дефолт для неоднозначных случаев
- **Производительность**: Быстрый анализ без внешних зависимостей

## Примеры

| Запрос | Маршрут | Причина |
|--------|---------|---------|
| "дата создания" | bm25 | short_or_entity_numeric |
| "почему небо голубое" | dense | conversational_or_long |
| "новости channel:tech после:2024-01-01" | hybrid | filters_or_mixed_signals |
| "кот в шляпе" | dense | default_dense |

Алгоритм эволюционирует через накопление паттернов и может быть расширен дополнительными правилами на основе анализа использования.


