# search - Инструмент гибридного поиска

## Обзор

Инструмент `search` выполняет гибридный поиск по коллекции документов с использованием RRF (Reciprocal Rank Fusion) слияния результатов. Поддерживает различные маршруты поиска и фильтрацию метаданных.

## Функциональность

### Основные возможности
- **Гибридный поиск**: Комбинация BM25 и dense поиска с RRF слиянием
- **Множественные запросы**: Поддержка списка запросов для поиска
- **Фильтрация метаданных**: Фильтры по датам, каналам, авторам и др.
- **Fallback стратегии**: Автоматический переход на BM25 при ошибках гибридного поиска
- **Стандартизированный формат**: Единый формат результатов поиска

### Параметры
- `queries` (List[str] или str, опционально): Список поисковых запросов
- `filters` (Dict, опционально): Фильтры метаданных
- `k` (int): Количество результатов (по умолчанию 10)
- `route` (str): Маршрут поиска ("hybrid"|"bm25"|"dense")
- `hybrid_retriever` (HybridRetriever, опционально): Гибридный ретривер
- `query` (str, опционально): Альтернативный способ задания запроса

### Возвращаемые данные
```python
{
    "hits": [
        {
            "id": "string",
            "score": float,
            "text": "string",
            "snippet": "string",
            "meta": {
                "channel_id": "string",
                "channel": "string",
                "message_id": "string",
                "date": "YYYY-MM-DDTHH:MM:SSZ",
                "author": "string",
                "is_forward": bool,
                "reply_to": "string|null",
                "links": [...],
                "media_types": [...],
                "lang": "ru|en",
                "hash": "hex"
            }
        }
    ],
    "total_found": int,
    "route_used": "hybrid|bm25"
}
```

## Алгоритм работы

1. **Нормализация запросов**: Объединение и дедупликация входных запросов
2. **Создание плана поиска**: Формирование SearchPlan с фильтрами
3. **Гибридный поиск**: Попытка выполнить гибридный поиск через HybridRetriever
4. **Fallback на BM25**: При ошибках гибридного поиска - переход на чистый BM25
5. **Пост-обработка**: Ограничение количества результатов, форматирование метаданных

## Интеграция с агентом

Используется в ReAct цикле для:
- Выполнения основного поиска по плану запроса
- Получения кандидатов для дальнейшего ранжирования
- Сбора документов для составления контекста

## Обработка ошибок

- Graceful fallback с BM25 при ошибках гибридного поиска
- Логирование всех этапов выполнения с таймингами
- Возврат пустого результата при критических ошибках

## Производительность

- Подробное логирование времени выполнения каждого этапа
- Оптимизация за счет использования существующих сервисов
- Поддержка кеширования через интеграцию с HybridRetriever