## –ü–ª–∞–Ω

### –¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –õ—ë–≥–∫–∏–π, –Ω–∞–¥—ë–∂–Ω—ã–π ReAct‚Äë–∞–≥–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö —Ç–µ–∫—É—â–µ–≥–æ FastAPI RAG –±–µ–∑ —Ç—è–∂—ë–ª—ã—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤.
- –ú–æ–¥–µ–ª—å‚Äë–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–æ –∏ CPU‚Äë–¥—Ä—É–∂–µ–ª—é–±–Ω–æ: –ª–æ–∫–∞–ª—å–Ω—ã–µ GGUF (llama.cpp), –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å; LLM‚Äë–≤—ã–∑–æ–≤—ã —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω—ã; async ‚Äî –¥–ª—è I/O/tool.
- –°—Ç—Ä–æ–≥–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä —Ç–∞–º, –≥–¥–µ –∫—Ä–∏—Ç–∏—á–Ω–æ: GBNF –¥–ª—è SearchPlan (3‚Äì6), JSON‚Äë–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã tool, –ø–æ—Å—Ç‚Äë–≤–∞–ª–∏–¥–∞—Ü–∏—è.
- Recall‚Üë –∑–∞ —Å—á—ë—Ç multi‚Äëquery + fusion (RRF), —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (MMR), –æ–ø—Ü. CPU cross‚Äëencoder rerank.
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç tool, —Ç—Ä–µ–π—Å —à–∞–≥–æ–≤ (–±–µ–∑ CoT) –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥, –∫–µ—à–∏/—Ç–∞–π–º–∞—É—Ç—ã/–¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏.
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Ç–µ–∫—É—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –Ω–µ –ª–æ–º–∞–µ–º; SSE ‚Äî —Å—Ç—Ä–∏–º–∏–º —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç; MVP ‚Äî self‚Äëhost.

### –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: `QueryPlannerService` (GBNF —Å—Ç–∞–±–∏–ª—å–Ω–æ 3‚Äì6) + TTL‚Äë–∫–µ—à (10 –º–∏–Ω) + –ø–æ—Å—Ç‚Äë–≤–∞–ª–∏–¥–∞—Ü–∏—è.
- –†–µ—Ç—Ä–∏–≤–µ—Ä—ã: Dense (Chroma), BM25, Hybrid (—Å –ø–ª–∞–Ω–æ–º).
- –°–ª–∏—è–Ω–∏–µ/–¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: `utils.ranking.rrf_merge`, `mmr_select`.
- –†–µ—Ä–µ–π–∫: `services.reranker_service.RerankerService` (CPU CrossEncoder).
- –ü—Ä–æ–º–ø—Ç/–æ—Ç–≤–µ—Ç: `utils.prompt.build_prompt`, LLM —Ñ–∞–±—Ä–∏–∫–∞, SSE —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
- –ò–Ω–∂–µ—Å—Ç: Telegram ‚Üí Chroma + BM25; –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏: `utils/gbnf.py` (–ø–æ–ª–Ω–∞—è/–º–∏–∫—Ä–æ).

### –ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ tool)
- `router_select` (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞ bm25|dense|hybrid)
- `multi_query_rewrite` (3‚Äì6 –ø–µ—Ä–µ—Ñ—Ä–∞–∑–æ–≤; –º–∏–∫—Ä–æ‚ÄëGBNF/Schema)
- `dedup_diversify` (MMR + –¥–µ–¥—É–ø id/–ª–µ–∫—Å–µ–º/URL)
- `fetch_docs` (–±–∞—Ç—á —Ç–µ–∫—Å—Ç—ã/–æ–∫–Ω–∞ –ø–æ ids –∏–∑ Chroma)
- `compose_context` (—Å–ø–∞–Ω—ã/—Ü–∏—Ç–∞—Ç—ã, –ª–∏–º–∏—Ç ~1800 —Ç–æ–∫–µ–Ω–æ–≤)
- `time_normalize` (RU/EN ‚Üí ISO –¥–∞—Ç—ã)
- `tool_runner`/`trace` (–µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç/—Ç–∞–π–º–∞—É—Ç—ã/–ª–æ–≥ stdout+—Ñ–∞–π–ª)

### –ë–∞–∑–æ–≤—ã–π ReAct‚Äë—Ñ–ª–æ—É (MVP)
1) router_select ‚Üí route‚àà{bm25|dense|hybrid}
2) plan (GBNF) ‚Üí subqueries(3‚Äì6), k_per_query, filters; –ø—Ä–∏ <3 ‚Üí –º–∏–∫—Ä–æ‚ÄëGBNF –¥–æ–≥–µ–Ω N
3) (–æ–ø—Ü.) multi_query_rewrite –¥–æ 4‚Äì6 –ø—Ä–∏ –Ω–∏–∑–∫–æ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–∏ –ø–ª–∞–Ω–∞
4) retrieval –ø–æ –ø—É–ª—É –∑–∞–ø—Ä–æ—Å–æ–≤ (hybrid –ª–∏–±–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç)
5) fusion: RRF(k=60) ‚Üí (–æ–ø—Ü.) MMR(Œª‚âà0.7, out_k)
6) (–æ–ø—Ü.) rerank (CPU CrossEncoder, top_n‚â§10‚Äì20)
7) fetch_docs(+windows) ‚Üí compose_context(‚â§~1800 —Ç–æ–∫–µ–Ω–æ–≤, –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)
8) finish: LLM generate; SSE ‚Äî —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
Halting: –ø—Ä–∏ —Å–ª–∞–±–æ–º –ø–æ–∫—Ä—ã—Ç–∏–∏ ‚Äî –æ–¥–∏–Ω –¥–æ–ø. —Ä–∞—É–Ω–¥ 4‚Äì7; –ª—é–±–æ–π fail tool ‚Üí ok:false –∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è (dense‚Äëonly, –±–µ–∑ rerank)

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (CPU, grammar): temperature‚âà0.2, top_p‚âà0.9, top_k‚âà40‚Äì50, repeat_penalty‚âà1.08‚Äì1.2, max_tokens‚âà256‚Äì384; –±–µ–∑ stop; —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π seed.
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: n_ctx‚âà4096; budget –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚âà1800 —Ç–æ–∫–µ–Ω–æ–≤; –æ—Ç–≤–µ—Ç ‚âà600‚Äì800 —Ç–æ–∫–µ–Ω–æ–≤.
- Fusion: RRF k=60; MMR Œª‚âà0.7; –ø–æ—Å–ª–µ fusion —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å ‚â§15‚Äì20 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.
- Rerank: top_n‚â§10‚Äì20, –±–∞—Ç—á –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π; –≤–∫–ª—é—á–∞—Ç—å –ø–æ –ø–æ—Ä–æ–≥—É/—Ñ–∏—á—Ñ–ª–∞–≥–æ–º.
- –¢–∞–π–º–∞—É—Ç—ã: tools 4‚Äì5s; –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ 8‚Äì10s; –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ ‚Äî –ø–æ –¥–ª–∏–Ω–µ.
- –ö–µ—à–∏: –ø–ª–∞–Ω 10 –º–∏–Ω; fusion 5 –º–∏–Ω; –∫–ª—é—á–∏ –≤–∫–ª—é—á–∞—é—Ç route –∏ –Ω–∞–±–æ—Ä subqueries.

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏—ë–º–∫–∏
- valid_json_rate (–ø–ª–∞–Ω) ‚â• 99.5%
- avg_subqueries ‚â• 3.2
- Recall@20 ‚â• baseline +10%
- citation‚Äëcoverage ‚â• 0.8
- p95 latency ‚â§ baseline +15%
- tool timeout rate < 1%, cache hit‚Äërate —Ä–∞–∑—É–º–Ω—ã–π

### –†–∏—Å–∫–∏ –∏ —Å–º—è–≥—á–µ–Ω–∏—è
- Latency‚Üë –∏–∑‚Äë–∑–∞ grammar/rerank ‚Üí –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å max_tokens, —É–∑–∫–∏–µ –º–∏–∫—Ä–æ‚ÄëGBNF, –º–∞–ª—ã–π top_n rerank, –≤–∫–ª—é—á–∞—Ç—å –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º.
- ¬´SQL/–∫–æ–¥¬ª –≤ subqueries ‚Üí –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ + —Ñ–∏–ª—å—Ç—Ä—ã —Å–∏–º–≤–æ–ª–æ–≤/–ª–µ–∫—Å–µ–º + –ø–æ—Å—Ç‚Äë–≤–∞–ª–∏–¥–∞—Ç–æ—Ä.
- –£—Ç–µ—á–∫–∏ CoT ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —à–∞–≥–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (JSON), –±–µ–∑ –º—ã—Å–ª–µ–π.
- –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ ‚Üí —à–∞–≥‚Äë–ª–∏–º–∏—Ç 3‚Äì4, –æ–¥–∏–Ω –¥–æ–ø. —Ä–∞—É–Ω–¥ –ø–æ–∏—Å–∫–∞ –º–∞–∫—Å–∏–º—É–º.

### –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (–∏—Ç–µ—Ä–∞—Ü–∏–∏)
- –ò—Ç–µ—Ä–∞—Ü–∏—è 1 ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ ¬´–ø—Ä–æ–¥¬ª: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
  - GBNF –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π, json_schema fallback; –º–∏–∫—Ä–æ‚ÄëGBNF –¥–æ–≥–µ–Ω; –ø–æ—Å—Ç‚Äë–≤–∞–ª–∏–¥–∞—Ç–æ—Ä; –º–µ—Ç—Ä–∏–∫–∏.
- –ò—Ç–µ—Ä–∞—Ü–∏—è 2 ‚Äî ¬´–ö–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å¬ª –±–µ–∑ ReAct: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
  - `router_select`, `compose_context`, `fetch_docs`, `dedup_diversify`; –∫–æ–Ω–≤–µ–π–µ—Ä: plan ‚Üí hybrid retrieval ‚Üí RRF ‚Üí (–æ–ø—Ü. MMR) ‚Üí (–æ–ø—Ü. rerank) ‚Üí compose ‚Üí answer.
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω answer_v2 –º–µ—Ç–æ–¥, tool_runner —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏, –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
- –ò—Ç–µ—Ä–∞—Ü–∏—è 3 ‚Äî ReAct –∫–∞—Ä–∫–∞—Å: üîÑ –¢–ï–ö–£–©–ê–Ø
  - Tool API (–µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç) ‚úÖ –≥–æ—Ç–æ–≤; ReAct‚Äë—Ü–∏–∫–ª —Å —à–∞–≥‚Äë–ª–∏–º–∏—Ç–æ–º; SSE –¥–ª—è –∞–≥–µ–Ω—Ç–∞; API `/v1/agent/*`.
  - –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: verify, math, time_now.
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
- –ò—Ç–µ—Ä–∞—Ü–∏—è 4 ‚Äî –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å/–∫–∞—á–µ—Å—Ç–≤–æ:
  - –ú–µ—Ç—Ä–∏–∫–∏ —à–∞–≥–æ–≤/—Ç–∞–π–º–∞—É—Ç–æ–≤/–∫–µ—à–µ–π, A/B ¬´–∫–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å vs ReAct¬ª, —Ç—é–Ω–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤; –æ–ø—Ü. `/v1/react/*` –∑–∞ —Ñ–∏—á—Ñ–ª–∞–≥–æ–º.

