# ADR-20241201-react-agent-api

**Дата**: 2024-12-01  
**Статус**: Принято  
**Авторы**: AI Assistant  
**Теги**: #agent #react #reasoning #tools #sse

## Контекст

Существующий RAG-сервис предоставляет эффективные API для поиска и ответов на вопросы (`/v1/qa/*`), но имеет ограничения для решения сложных задач, требующих:

- Пошагового рассуждения и планирования
- Использования множественных инструментов
- Верификации промежуточных результатов
- Наблюдаемости процесса принятия решений
- Итеративного уточнения запросов

Пользователи запрашивали возможности для более сложных сценариев, таких как:
- Многошаговый анализ с проверкой фактов
- Математические вычисления в контексте поиска
- Планирование запросов с адаптацией стратегии

## Решение

Реализован **ReAct Agent API** — новый набор эндпоинтов для пошагового мышления и выполнения действий с полной наблюдаемостью.

### Ключевые компоненты

1. **AgentService** (`src/services/agent_service.py`)
   - ReAct петля: Thought → Action → Observation → FinalAnswer
   - SSE стриминг всех шагов для реального времени
   - Fallback через существующий QAService

2. **Agent Tools** (`src/services/tools/`)
   - 7 инструментов: router_select, fetch_docs, compose_context, dedup_diversify, verify, math_eval, time_now
   - ToolRunner с таймаутами и JSON-трейсингом
   - Инъекция зависимостей через обертки

3. **Agent API** (`src/api/v1/endpoints/agent.py`)
   - `POST /v1/agent/stream` — основной SSE эндпоинт
   - `GET /v1/agent/tools` — список доступных инструментов
   - `GET /v1/agent/status` — конфигурация агента

4. **Схемы данных** (`src/schemas/agent.py`)
   - AgentRequest, AgentResponse, AgentStepEvent
   - Расширение существующих ToolRequest/ToolResponse

### Архитектурные принципы

- **Неинвазивность**: Полная совместимость с существующими API
- **Повторное использование**: Максимальное переиспользование компонентов (LLM, Retriever, Settings)
- **Наблюдаемость**: JSON-трейсинг и SSE события для всех действий
- **Отказоустойчивость**: Множественные fallback механизмы
- **Конфигурируемость**: Настройки через переменные окружения

## Альтернативы

### Альтернатива 1: Расширение существующего QAService
**Отклонено**: Нарушило бы принцип единственной ответственности и усложнило бы существующий код.

### Альтернатива 2: Внешний агент-сервис
**Отклонено**: Потребовал бы дублирования зависимостей и усложнил бы деплоймент.

### Альтернатива 3: Синхронный API вместо SSE
**Отклонено**: Не обеспечил бы наблюдаемость пошагового выполнения.

## Последствия

### Положительные

1. **Расширенные возможности**
   - Поддержка сложных многошаговых задач
   - Пошаговая наблюдаемость выполнения
   - Верификация и факт-чек в процессе

2. **Архитектурная целостность**
   - Сохранение всех существующих API без изменений
   - Переиспользование 90% существующей инфраструктуры
   - Соответствие паттернам проекта

3. **Операционные преимущества**
   - JSON-трейсинг для отладки и аналитики
   - Настраиваемые таймауты и лимиты
   - Graceful degradation через fallback

### Отрицательные

1. **Увеличение сложности**
   - +392 LOC в AgentService
   - +7 новых инструментов
   - Дополнительные тесты и документация

2. **Потребление ресурсов**
   - Дополнительная память для AgentService в кеше
   - Увеличенное количество вызовов LLM
   - SSE соединения держат HTTP-соединения открытыми

3. **Операционные риски**
   - Новые точки отказа в ToolRunner
   - Потенциальные race conditions в SSE
   - Необходимость мониторинга новых компонентов

## Метрики успеха

1. **Функциональные**
   - Успешное решение многошаговых задач
   - Время ответа < 30 сек для типичных сценариев
   - Коэффициент успешного завершения > 85%

2. **Техническиe**
   - Отсутствие регрессий в существующих API
   - Потребление памяги < +20% от базового уровня
   - Покрытие тестами > 80% для новых компонентов

3. **Операционные**
   - Простота развертывания (без изменений Docker/compose)
   - Совместимость с существующими мониторингом
   - Возможность отключения через переменные окружения

## Реализация

- **Итерация 3**: Полная реализация AgentService, всех инструментов, API и тестов
- **Статус**: ✅ Завершено
- **Следующие шаги**: Мониторинг производительности, оптимизация промптов, расширение набора инструментов

## Связанные решения

- Использует существующую архитектуру из `docs/ai/architecture.md`
- Расширяет пайплайны из `docs/ai/pipelines.md`
- Следует паттернам зависимостей из `src/core/deps.py`
